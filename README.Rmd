---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# mapscvi

<!-- badges: start -->
<!-- badges: end -->

Map single cell expression data in a seurat object into reference scvi latent space and reference umap based on seurat.

## Installation

Install mapscvi using:

``` r
devtools::install_github("lsteuernagel/mapscvi")
```

In order to use the package python and scvi >= 0.8, as well as R and Seurat > 4.0.0 are required.

A docker image which comes with a compatible R, Seurat v4, pytorch and scvi installation can be found here: https://hub.docker.com/r/lsteuernagel/r_scvi 

## Example

This package allows to embed new single-cell data stored in Seurat objects into HypoMap.

The functions used to do this can also be used to embed data into other models.

An example workflow that emebds the romanov et al. smart-seq dataset into the HypoMap:

```{r example}
library(mapscvi)
#You'll still need to render `README.Rmd` regularly, to keep `README.md` up-to-date. `devtools::build_readme()` is handy for this. You could also use GitHub Actions to re-render `README.Rmd` every time you push. An example workflow can be found here: <https://github.com/r-lib/actions/tree/master/examples>.
```

We load the example data which contains a Seurat object.

```{r cars}
load("/beegfs/scratch/bruening_scratch/lsteuernagel/data/tmp_mapscvi/query_test_object.RData")
query_seurat_object
```

The test data does not contain any dimensional reductions for visualization or annotation.

```{r}
names(query_seurat_object@reductions)
```

To map data to the reference HypoMap, we load a reduced Seurat object with relevant information.

```{r}
load("/beegfs/scratch/bruening_scratch/lsteuernagel/data/tmp_mapscvi/reference_hypoMap.RData")
```


This wrapper function executes all required mapping steps. We provide the query object as well as a column from HypoMap which we want to predict.

```{r message=FALSE, warning=FALSE, include=FALSE}
query_seurat_object = map_new_seurat_hypoMap(query_seurat_object,suffix="query_romanov",label_col="K169_named",max_epochs=20,reference_seurat=reference_hypoMap)
names(query_seurat_object@reductions)
```

Take a look at the top clusters that were found in the query:

```{r}
head(sort(table(query_seurat_object@meta.data$predicted),decreasing = TRUE),n = 10)
```
The package provides plotting functions to visualize the query on the reference:

Plot them side by side. Here we set labelonplot to False to prevent cluster labels from being plotted.

```{r}
plot_query_labels(query_seura_object=query_seurat_object,reference_seurat=reference_hypoMap,label_col="K169_named",overlay = FALSE,labelonplot = FALSE)
```

Overlay them query over the reference. The overlay parameters allow to change the behavior of query points. Here we set labelonplot to True to include cluster labels on the plot. We can use the Seurat::DimPlot parameters to further adjust the plots. E.g. by decreasing the size of the labels.

```{r}
plot_query_labels(query_seura_object=query_seurat_object,reference_seurat=reference_hypoMap,label_col="K169_named",overlay = TRUE,overlay_pt_size = 0.4,labelonplot = TRUE,label.size=1)
```



## Preparing a Seurat object

TODO: Showcase helper function and provide a guide on how to get to a Seurat object with the right format.


## Detailed walkthrough

TODO: Explain all individual setup
